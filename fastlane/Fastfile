default_platform(:ios)

platform :ios do
  desc "Run SwiftLint"
  lane :lint do
    swiftlint(
      mode: :lint,
      quiet: true,
      strict: true,
      ignore_exit_status: true
    )
  end

  desc "Format Swift code"
  lane :format_code do
    sh "swift-format format -i -r ../Little\\ Moments --configuration ../.swift-format.json || true"
  end

  desc "Run tests"
  lane :test do
    begin
      scan(
        scheme: "Little Moments",
        device: "iPhone 15",
        clean: true
      )
    rescue
      UI.important("Tests failed but continuing...")
    end
  end

  desc "Build the app"
  lane :build do
    begin
      sh "xcodebuild -scheme 'Little Moments' -project ../LittleMoments.xcodeproj -sdk iphonesimulator -destination 'platform=iOS Simulator,name=iPhone 16' build"
    rescue
      UI.important("Build failed but continuing...")
    end
  end

  desc "Run all quality checks and tests"
  lane :quality_check do
    format_code
    lint
    test
    build
  end
end 